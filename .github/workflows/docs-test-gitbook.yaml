name: Test GitBook Migration

on:
  push:
    branches: [test-gitbook-docs]
  workflow_dispatch:

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.13
          activate-environment: true

      - name: Install dependencies
        run: |
          uv sync --group docs
          uv pip install lazydocs

      - name: Build Documentation (Test)
        run: |
          # 1. Prepare site folder
          rm -fr site
          mkdir -p site

          # Copy docs
          cp -r docs/* site/
          rm -fr site/api

          # 2. Generate actual markdown files for 'any_agent'
          # This replaces pydoc-markdown. It reads your code and outputs .md files.
          uv run lazydocs \
            --output-path site/api \
            --overview-file README.md \
            --src-base-url "https://github.com/angpt/any-agent/blob/main/" \
            src/any_agent

          # 3. Create a Dummy Summary for testing if one doesn't exist
          # If SUMMARY.md doesn't exist, create it
          if [ ! -f site/SUMMARY.md ]; then
            echo "# Table of Contents" > site/SUMMARY.md
            echo "" >> site/SUMMARY.md

            # Add existing static files to summary (simple loop)
            find site -maxdepth 1 -name "*.md" ! -name "SUMMARY.md" ! -name "api-reference.md" | sort | while read filename; do
                name=$(basename "$filename" .md)
                echo "* [$name]($name.md)" >> site/SUMMARY.md
            done
          fi

          # Add Manual Guides (everything except the api folder)
          echo "## Guides" >> site/SUMMARY.md
          find site -maxdepth 1 -name "*.md" ! -name "SUMMARY.md" | sort | while read filename; do
            name=$(basename "$filename" .md)
            echo "* [$name]($name.md)" >> site/SUMMARY.md
          done

          # Add API Reference (The new generated files)
          echo "" >> site/SUMMARY.md
          echo "## API Reference" >> site/SUMMARY.md
          echo "* [Overview](api/README.md)" >> site/SUMMARY.md

          # Add all generated module files
          find site/api -name "*.md" ! -name "README.md" | sort | while read filename; do
            # Calculate relative path (e.g. api/module_name.md)
            relpath=${filename#site/}
            name=$(basename "$filename" .md)
            echo "* [$name]($relpath)" >> site/SUMMARY.md
          done

      - name: Deploy to STAGING Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gitbook-staging # SAFE THROWAWAY BRANCH
          force_orphan: true
